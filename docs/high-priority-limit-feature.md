# Функциональность проверки лимита срочных задач

## Обзор

Добавлена проверка лимита в 5 срочных задач при выборе высокого приоритета (Critical/Blocker/High). При превышении лимита система предлагает пользователю понизить приоритет новой задачи или оставить высокий приоритет.

## Техническая реализация

### 1. Новые функции в `utils/gsheets.py`

#### `get_high_priority_tasks() -> Tuple[List[dict], int]`
Читает два листа Google Sheets и возвращает список срочных задач:

**Основной лист (`GSHEET_WORKSHEET_NAME`):**
- Столбец C (индекс 2): статус разработки
- Столбец D (индекс 3): приоритет
- Извлекает задачи с приоритетом Critical/Blocker/High И статусом из списка активных

**Лист задач (`GSHEET_TASKS_WORKSHEET_NAME`):**
- Ищет столбец с заголовком "Приоритет" или "Priority"
- Извлекает ВСЕ задачи с приоритетом Critical/Blocker/High

**Активные статусы разработки:**
- ToDo, Analytics, Design, Ready for Dev, Development, Testing, Review

**Возвращаемые данные:**
```python
{
    "priority": "Critical|Blocker|High",
    "description": "Описание задачи",
    "status": "Статус разработки или N/A",
    "sheet": "main|tasks",
    "row": номер_строки
}
```

#### `format_tasks_message(existing_tasks: List[dict], new_task_description: str) -> str`
Формирует читаемое сообщение о превышении лимита:

```
@pakhandrin Превышено максимум задач в работе!

Текущие срочные задачи:
- [Critical] Описание задачи 1 (Development)
- [High] Описание задачи 2 (Testing)
- [Blocker] Описание задачи 3 (ToDo)

Новая задача:
- Описание новой задачи

Что делаем: бросаем старые задачи и идем делать новую или оставляем старые и понижаем приоритет новой?
```

#### `is_high_priority_limit_exceeded() -> bool`
Проверяет, превышен ли лимит срочных задач (>= 5).

### 2. Константы

```python
HIGH_PRIORITY_LIMIT = 5  # Лимит срочных задач
MANAGER_USERNAME = "@pakhandrin"  # Username менеджера для уведомлений
```

### 3. Модификация обработчика приоритетов

#### Функция `handle_priority_callback` в `bot/handlers.py`

**Логика работы:**
1. При выборе Critical/Blocker/High проверяется лимит
2. Если лимит превышен (>= 5):
   - Получается список существующих срочных задач
   - Формируется сообщение с помощью `format_tasks_message()`
   - Показываются новые кнопки: "Medium", "Low", "Оставить высокий"
   - Задача НЕ добавляется в Google Sheets
3. Если лимит не превышен: работает как обычно

**Новые кнопки:**
- `downgrade:{pending_id}:medium` - понизить до Medium
- `downgrade:{pending_id}:low` - понизить до Low  
- `keep_high:{pending_id}` - оставить высокий приоритет

### 4. Новые обработчики

#### `handle_downgrade_callback`
Обрабатывает понижение приоритета:
1. Устанавливает новый приоритет в БД
2. Добавляет задачу в Google Sheets с пониженным приоритетом
3. Удаляет из `pending_prioritization`
4. Отправляет подтверждение

#### `handle_keep_high_callback`
Обрабатывает сохранение высокого приоритета:
1. Отправляет сообщение "Необходимо определить задачу, приоритет которой будет понижен"
2. Оставляет задачу в `pending_prioritization`
3. НЕ добавляет в Google Sheets

### 5. Регистрация обработчиков

В `main.py` добавлены новые обработчики:
```python
application.add_handler(CallbackQueryHandler(handle_downgrade_callback, pattern=r"^downgrade:"))
application.add_handler(CallbackQueryHandler(handle_keep_high_callback, pattern=r"^keep_high:"))
```

## Поток работы

### Сценарий 1: Лимит не превышен
1. Пользователь выбирает Critical/Blocker/High
2. Система проверяет количество срочных задач (< 5)
3. Задача добавляется в Google Sheets
4. Запись удаляется из `pending_prioritization`
5. Отправляется подтверждение

### Сценарий 2: Лимит превышен
1. Пользователь выбирает Critical/Blocker/High
2. Система проверяет количество срочных задач (>= 5)
3. Показывается сообщение о превышении лимита
4. Предлагаются варианты действий:
   - **Medium/Low**: понизить приоритет и добавить в Sheets
   - **Оставить высокий**: оставить задачу в очереди

## Обработка ошибок

### При ошибках чтения Google Sheets
- Функция `get_high_priority_tasks()` возвращает пустой список и 0
- Функция `is_high_priority_limit_exceeded()` возвращает `False`
- Система разрешает добавление задачи (graceful degradation)

### Логирование
Все операции логируются с уровнем INFO/WARNING/ERROR:
- Успешные операции
- Ошибки при чтении листов
- Превышение лимита
- Действия пользователя

## Тестирование

### Тестовый скрипт
Создан `test_high_priority_limit.py` для проверки:
1. Получения срочных задач
2. Проверки лимита
3. Форматирования сообщений

### Запуск тестов
```bash
cd telegram_bot
python test_high_priority_limit.py
```

## Конфигурация

### Переменные окружения
- `GSHEET_WORKSHEET_NAME` - название основного листа
- `GSHEET_TASKS_WORKSHEET_NAME` - название листа задач
- `GSHEET_SPREADSHEET_ID` - ID Google таблицы
- `GOOGLE_SERVICE_ACCOUNT_JSON_PATH` - путь к JSON файлу сервисного аккаунта

### Структура листов
**Основной лист:**
- Столбец A: Проект
- Столбец B: Описание  
- Столбец C: Статус разработки
- Столбец D: Приоритет

**Лист задач:**
- Столбец A: Проект
- Столбец B: Описание
- Столбец C: Приоритет

## Ограничения

1. **Лимит**: Захардкожен как 5 срочных задач
2. **Username менеджера**: Захардкожен как "@pakhandrin"
3. **Столбцы**: Позиции столбцов C и D захардкожены для основного листа
4. **Статусы**: Список активных статусов захардкожен

## Возможности расширения

1. **Настраиваемый лимит**: Вынести в переменные окружения
2. **Настраиваемый username**: Вынести в переменные окружения  
3. **Гибкие столбцы**: Определение позиций столбцов через конфигурацию
4. **Настраиваемые статусы**: Список активных статусов через конфигурацию
5. **Уведомления**: Отправка уведомлений в другие чаты/каналы
