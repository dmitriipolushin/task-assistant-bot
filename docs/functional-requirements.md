# Функциональные требования Telegram бота для анализа задач

## 1. Общее описание системы

Telegram бот предназначен для автоматического анализа сообщений в групповых чатах разработческой студии, извлечения задач от клиентов и их систематизации с приоритизацией.

## 2. Основные функции

### 2.1 Автоматический сбор сообщений
- **Сбор сообщений**: Бот автоматически собирает все сообщения от клиентов в групповых чатах
- **Фильтрация**: Игнорирует сообщения от сотрудников студии (определяется по списку staff_members)
- **Хранение**: Сохраняет сообщения в базу данных с меткой времени и статусом обработки

### 2.2 Обработка сообщений с помощью GPT
- **Пакетная обработка**: Анализирует сообщения за последний час с помощью OpenAI GPT
- **Извлечение задач**: Использует специальный промпт для извлечения конкретных задач из диалогов
- **Контекстный анализ**: Анализирует весь контекст диалога, а не каждое сообщение отдельно
- **Объединение задач**: Группирует связанные задачи в одну функцию

### 2.3 Система приоритизации
- **Уровни приоритета**: Critical, Blocker, High, Medium, Low
- **Интерактивный выбор**: Предоставляет inline-клавиатуру для выбора приоритета
- **Редактирование задач**: Возможность изменить формулировку задачи перед выбором приоритета
- **Ограничения**: Контролирует лимит срочных задач (Critical/Blocker/High ≤ 5)
- **Уведомления**: Автоматически уведомляет о превышении лимита

### 2.4 Команды бота

#### 2.4.1 Команды для всех пользователей
- `/tasks [страница]` - Просмотр всех задач с пагинацией

#### 2.4.2 Команды только для сотрудников
- `/process_now` - Принудительная обработка сообщений за последний час
- `/parse [дни]` - Обработка сообщений за указанное количество дней (игнорирует статус is_processed)
- `/prioritize` - Показ задач, требующих выбора приоритета

### 2.5 Автоматическое планирование
- **Ежечасная обработка**: Автоматическая обработка сообщений каждый час в 00 минут
- **Ежедневные отчеты**: Отправка отчетов о задачах за предыдущий день в заданное время
- **Настраиваемое время**: Конфигурируемое время отправки отчетов (по умолчанию 09:00)

### 2.6 Редактирование задач
- **Редактирование формулировки**: Возможность изменить текст задачи перед выбором приоритета
- **Интерактивный процесс**: Кнопка "Редактировать" → ввод нового текста → повторный показ выбора приоритета
- **Автоматическое обновление**: Изменения сохраняются в базе данных и Google Sheets

## 3. Интеграция с внешними системами

### 3.1 Google Sheets
- **Автоматическая синхронизация**: Задачи с выбранным приоритетом автоматически добавляются в Google Sheets
- **Формат данных**: Проект (Calzen), Описание, Приоритет
- **Управление лимитами**: Контроль количества срочных задач
- **Возможность удаления**: Удаление задач из таблицы при необходимости

### 3.2 OpenAI API
- **Модель**: Настраиваемая GPT модель
- **Промпты**: Специализированные промпты для извлечения задач
- **Retry логика**: Автоматические повторные попытки при ошибках API
- **Таймауты**: Настраиваемые таймауты для API вызовов

## 4. База данных

### 4.1 Основные таблицы
- **raw_messages**: Сырые сообщения от клиентов
- **processed_tasks**: Обработанные и извлеченные задачи
- **pending_prioritization**: Задачи, ожидающие выбора приоритета
- **staff_members**: Список сотрудников студии

### 4.2 Индексы и оптимизация
- Индексы по chat_id, timestamp, is_processed
- Автоматическое создание схемы при инициализации

## 5. Безопасность и права доступа

### 5.1 Аутентификация
- Проверка пользователей по username и user_id
- Список разрешенных сотрудников в базе данных
- Разграничение доступа к командам

### 5.2 Конфигурация
- Переменные окружения для API ключей
- Настройки через .env файл
- Валидация обязательных параметров

## 6. Логирование и мониторинг

### 6.1 Уровни логирования
- DEBUG: Детальная информация о работе
- INFO: Основные операции и статистика
- WARNING: Предупреждения и повторные попытки
- ERROR: Ошибки и исключения

### 6.2 Отслеживаемые события
- Обработка команд пользователей
- API вызовы к OpenAI
- Операции с базой данных
- Интеграция с Google Sheets
- Планировщик задач

## 7. Обработка ошибок

### 7.1 Стратегии восстановления
- Автоматические повторные попытки для API вызовов
- Exponential backoff с jitter для сетевых ошибок
- Graceful degradation при недоступности внешних сервисов

### 7.2 Уведомления пользователей
- Информативные сообщения об ошибках
- Статус выполнения операций
- Подтверждения успешных действий

## 8. Производительность

### 8.1 Оптимизации
- Пакетная обработка сообщений
- Асинхронные операции
- Индексы базы данных
- Разделение длинных сообщений

### 8.2 Ограничения
- Максимальная длина сообщения Telegram: 4096 символов
- Таймауты API вызовов: 60 секунд
- Лимит срочных задач: 5 (Critical/Blocker/High)
- Лимит важных задач: 10 (для Google Sheets интеграции)

## 9. Развертывание и конфигурация

### 9.1 Docker поддержка
- Dockerfile для контейнеризации
- docker-compose.yml для оркестрации
- Переменные окружения для конфигурации

### 9.2 Переменные окружения
- **BOT_TOKEN**: Токен Telegram бота
- **OPENAI_API_KEY**: Ключ API OpenAI
- **OPENAI_BASE_URL**: Базовый URL для OpenAI API
- **GPT_MODEL**: Модель GPT для использования
- **TIMEZONE**: Часовой пояс (по умолчанию Europe/Moscow)
- **DAILY_REPORT_TIME**: Время отправки ежедневных отчетов
- **DATABASE_PATH**: Путь к базе данных SQLite
- **GSHEET_SPREADSHEET_ID**: ID Google таблицы
- **GOOGLE_SERVICE_ACCOUNT_JSON_PATH**: Путь к JSON файлу сервисного аккаунта

## 10. Расширяемость

### 10.1 Модульная архитектура
- Разделение на логические модули (handlers, scheduler, gpt_processor)
- Утилиты для форматирования и интеграции
- Конфигурация через настройки

### 10.2 Возможности расширения
- Добавление новых команд
- Интеграция с дополнительными внешними сервисами
- Кастомизация промптов GPT
- Расширение системы приоритетов

## 11. Требования к окружению

### 11.1 Системные требования
- Python 3.8+
- SQLite3
- Доступ к интернету для API вызовов

### 11.2 Зависимости
- python-telegram-bot
- openai
- gspread
- python-dotenv
- apscheduler
- zoneinfo

## 12. Тестирование и качество

### 12.1 Логирование
- Подробное логирование всех операций
- Отслеживание производительности
- Мониторинг ошибок

### 12.2 Обработка исключений
- Try-catch блоки для всех критических операций
- Graceful fallback при ошибках
- Информативные сообщения об ошибках для пользователей
