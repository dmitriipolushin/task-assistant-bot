# Функциональные требования Telegram бота для анализа задач

## 1. Общее описание системы

Telegram бот предназначен для автоматического анализа сообщений в групповых чатах разработческой студии, извлечения задач от клиентов и их систематизации с приоритизацией.

## 2. Основные функции

### 2.1 Автоматический сбор сообщений
- **Сбор сообщений**: Бот автоматически собирает все сообщения от клиентов в групповых чатах
- **Фильтрация**: Игнорирует сообщения от сотрудников студии (определяется по списку staff_members)
- **Хранение**: Сохраняет сообщения в базу данных PostgreSQL с меткой времени и статусом обработки

### 2.2 Обработка сообщений с помощью GPT
- **Пакетная обработка**: Анализирует сообщения за последний час с помощью OpenAI GPT
- **Извлечение задач**: Использует специальный промпт для извлечения конкретных задач из диалогов
- **Контекстный анализ**: Анализирует весь контекст диалога, а не каждое сообщение отдельно
- **Объединение задач**: Группирует связанные задачи в одну функцию

### 2.3 Система приоритизации
- **Уровни приоритета**: Critical, Blocker, High, Medium, Low
- **Интерактивный выбор**: Предоставляет inline-клавиатуру для выбора приоритета
- **Редактирование задач**: Возможность изменить формулировку задачи перед выбором приоритета
- **Ограничения**: Контролирует лимит срочных задач (Critical/Blocker/High ≤ 5)
- **Уведомления**: Автоматически уведомляет о превышении лимита

### 2.4 Команды бота

#### 2.4.1 Команды для всех пользователей
- `/tasks [страница]` - Просмотр всех задач с пагинацией

#### 2.4.2 Команды только для сотрудников
- `/process_now` - Принудительная обработка сообщений за последний час
- `/parse [дни]` - Обработка сообщений за указанное количество дней (игнорирует статус is_processed)
- `/prioritize` - Показ задач, требующих выбора приоритета

### 2.5 Автоматическое планирование
- **Ежечасная обработка**: Автоматическая обработка сообщений каждый час в 00 минут
- **Настраиваемое время**: Конфигурируемое время обработки через TIMEZONE (по умолчанию Europe/Moscow)

### 2.6 Редактирование задач
- **Редактирование формулировки**: Возможность изменить текст задачи перед выбором приоритета
- **Интерактивный процесс**: Кнопка "Редактировать" → ввод нового текста → повторный показ выбора приоритета
- **Автоматическое обновление**: Изменения сохраняются в базе данных и Google Sheets

## 3. Интеграция с внешними системами

### 3.1 Google Sheets
- **Автоматическая синхронизация**: Задачи с выбранным приоритетом автоматически добавляются в Google Sheets
- **Формат данных**: Проект (Calzen), Описание, Приоритет, **Контекст**
- **Поле "Контекст"**: Автоматическое добавление ссылок на исходные сообщения в чате
- **Кликабельные ссылки**: Возможность быстро перейти к первоисточнику задачи
- **Управление лимитами**: Контроль количества срочных задач
- **Возможность удаления**: Удаление задач из таблицы при необходимости

#### 3.1.1 Поле "Контекст"
Поле "Контекст" содержит ссылки на исходные сообщения, из которых была извлечена задача:

- **Формат ссылок**: `https://t.me/c/{chat_id}/{message_id}`
- **Множественные ссылки**: Если задача извлечена из нескольких сообщений, ссылки разделяются символом ` | `
- **Автоматическое формирование**: Ссылки создаются автоматически при выборе приоритета
- **Контекстная информация**: Позволяет разработчикам понять полный контекст запроса клиента
- **Безопасность**: Ссылки доступны только участникам чата

### 3.2 OpenAI API
- **Модель**: Настраиваемая GPT модель
- **Промпты**: Специализированные промпты для извлечения задач
- **Retry логика**: Автоматические повторные попытки при ошибках API
- **Таймауты**: Настраиваемые таймауты для API вызовов

## 4. База данных

### 4.1 Основные таблицы
- **raw_messages**: Сырые сообщения от клиентов
- **processed_tasks**: Обработанные и извлеченные задачи
- **pending_prioritization**: Задачи, ожидающие выбора приоритета
- **staff_members**: Список сотрудников студии

### 4.2 Индексы и оптимизация
- Индексы по chat_id, timestamp, is_processed
- Автоматическое создание схемы при инициализации

## 5. Безопасность и права доступа

### 5.1 Аутентификация
- Проверка пользователей по username и user_id
- Список разрешенных сотрудников в базе данных
- Разграничение доступа к командам

### 5.2 Конфигурация
- Переменные окружения для API ключей
- Настройки через .env файл
- Валидация обязательных параметров

## 6. Логирование и мониторинг

### 6.1 Уровни логирования
- DEBUG: Детальная информация о работе
- INFO: Основные операции и статистика
- WARNING: Предупреждения и повторные попытки
- ERROR: Ошибки и исключения

### 6.2 Отслеживаемые события
- Обработка команд пользователей
- API вызовы к OpenAI
- Операции с базой данных
- Интеграция с Google Sheets
- Планировщик задач

## 7. Обработка ошибок

### 7.1 Типы ошибок
- Ошибки подключения к PostgreSQL
- Ошибки OpenAI API
- Ошибки Google Sheets API
- Ошибки Telegram Bot API

### 7.2 Стратегии восстановления
- Автоматические повторные попытки
- Fallback механизмы
- Детальное логирование ошибок
- Graceful degradation функциональности
