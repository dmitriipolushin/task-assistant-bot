# Настройка Google Sheets для Telegram Bot

## Обзор

Telegram Bot может интегрироваться с Google Sheets для автоматического сохранения задач. Эта интеграция опциональна - бот будет работать и без неё, но не сможет сохранять задачи в таблицы.

## Требования

1. Google Cloud Project с включенным Google Sheets API
2. Сервисный аккаунт Google
3. Файл ключей сервисного аккаунта (JSON)
4. Google Sheets таблица с правами на редактирование

## Пошаговая настройка

### 1. Создание Google Cloud Project

1. Перейдите в [Google Cloud Console](https://console.cloud.google.com/)
2. Создайте новый проект или выберите существующий
3. Включите Google Sheets API:
   - Перейдите в "APIs & Services" > "Library"
   - Найдите "Google Sheets API" и включите его

### 2. Создание сервисного аккаунта

1. В "APIs & Services" > "Credentials" нажмите "Create Credentials"
2. Выберите "Service Account"
3. Заполните информацию о сервисном аккаунте
4. Создайте ключ (JSON формат)
5. Скачайте файл ключей

### 3. Настройка Google Sheets

1. Создайте новую Google Sheets таблицу
2. Скопируйте ID таблицы из URL (длинная строка между /d/ и /edit)
3. Предоставьте доступ сервисному аккаунту:
   - Нажмите "Share" в правом верхнем углу
   - Добавьте email сервисного аккаунта (из файла JSON)
   - Дайте права "Editor"

### 4. Настройка переменных окружения

Создайте файл `.env` в корне проекта и добавьте:

```bash
# Google Sheets settings
GOOGLE_SERVICE_ACCOUNT_JSON_PATH=path/to/your-service-account.json
GSHEET_SPREADSHEET_ID=your_spreadsheet_id_here
GSHEET_WORKSHEET_NAME=Tasks
GSHEET_TASKS_WORKSHEET_NAME=Tasks
```

**Важно:**
- `GOOGLE_SERVICE_ACCOUNT_JSON_PATH` - путь к файлу JSON ключей
- `GSHEET_SPREADSHEET_ID` - ID таблицы Google Sheets
- Остальные настройки опциональны

### 5. Размещение файла ключей

Поместите файл JSON ключей в корень проекта или укажите полный путь в переменной окружения.

## Структура таблицы

Бот автоматически создаст лист "Tasks" с заголовками:
- **Проект** - всегда "Calzen"
- **Описание** - текст извлеченной задачи
- **Приоритет** - выбранный приоритет (Critical, Blocker, High, Medium, Low)
- **Контекст** - ссылки на исходные сообщения в чате

### Поле "Контекст"

Поле "Контекст" содержит кликабельные ссылки на исходные сообщения, из которых была извлечена задача. Это позволяет разработчикам:

- Быстро перейти к первоисточнику задачи
- Увидеть полный контекст запроса клиента
- Понять детали и нюансы требований
- Связаться с клиентом при необходимости уточнений

**Формат ссылок:**
```
https://t.me/c/{chat_id}/{message_id}
```

**Пример содержимого:**
```
https://t.me/c/1234567890/123 | https://t.me/c/1234567890/124
```

Если задача была извлечена из нескольких сообщений, ссылки разделяются символом ` | `.

## Проверка работы

После настройки:
1. Перезапустите бота
2. Создайте новую задачу
3. Выберите приоритет
4. Проверьте, что задача появилась в Google Sheets с заполненным полем "Контекст"

## Устранение неполадок

### Ошибка "Google Sheets is not configured"

Проверьте:
- Правильность путей в `.env` файле
- Наличие файла ключей
- Корректность ID таблицы

### Ошибка "Service account JSON missing required fields"

Проверьте:
- Целостность файла JSON ключей
- Наличие всех обязательных полей

### Ошибка "Worksheet not found"

Бот автоматически создаст лист "Tasks" при первом использовании.

### Поле "Контекст" пустое

Возможные причины:
- Ошибка при получении ID исходных сообщений
- Проблемы с доступом к базе данных
- Задача была создана до добавления функциональности контекста

## Безопасность

- Файл `.env` добавлен в `.gitignore`
- Файл ключей сервисного аккаунта также в `.gitignore`
- Никогда не коммитьте эти файлы в репозиторий
- Ссылки на сообщения доступны только участникам чата

## Отключение Google Sheets

Если вы хотите отключить интеграцию с Google Sheets:
1. Удалите или закомментируйте переменные Google Sheets в `.env`
2. Бот продолжит работать, но не будет сохранять задачи в таблицы

## Дополнительные возможности

### Автоматическое создание заголовков

При первом использовании бот автоматически создает заголовки таблицы на русском языке. Если вы хотите использовать английские заголовки, измените переменную `GSHEET_WORKSHEET_NAME` на "Tasks" (английский).

### Обработка групповых чатов

Бот корректно обрабатывает групповые чаты и формирует ссылки, убирая знак минус из chat_id для корректного отображения ссылок.
