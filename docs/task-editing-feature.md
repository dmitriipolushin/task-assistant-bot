# Функциональность редактирования задач

## Обзор

Добавлена возможность редактирования формулировки задачи перед выбором приоритета. Пользователь может изменить текст задачи, если GPT неправильно извлек или сформулировал задачу.

## Техническая реализация

### 1. Кнопка "Редактировать"

#### Места размещения
- **Автоматические уведомления** о новых задачах (функция `_prompt_priority_selection`)
- **Команда `/prioritize`** (функция `handle_prioritize_command`)

#### Структура кнопки
```python
InlineKeyboardButton("Редактировать", callback_data=f"edit:{pending_id}")
```

### 2. Обработчик редактирования

#### Функция `handle_edit_task_callback`
```python
async def handle_edit_task_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
```

**Логика работы:**
1. Получает `pending_id` из callback_data
2. Проверяет существование задачи в базе
3. Сохраняет `pending_id` и `chat_id` в контексте пользователя
4. Отправляет сообщение "Напишите правильную формулировку задачи"
5. Активирует режим редактирования для пользователя

### 3. Логика обработки редактирования

#### Интеграция в `handle_message`
```python
# Проверяем, находится ли пользователь в режиме редактирования задачи
if context.user_data.get('editing_task_id') and context.user_data.get('editing_chat_id') == chat.id:
```

**Процесс редактирования:**
1. **Активация режима** - при нажатии кнопки "Редактировать"
2. **Ожидание ввода** - бот ждет следующее сообщение от пользователя
3. **Обработка текста** - новое сообщение принимается как текст задачи
4. **Обновление базы** - задача обновляется в таблице `pending_prioritization`
5. **Повторный показ** - отправляется новое сообщение с выбором приоритета
6. **Очистка контекста** - режим редактирования деактивируется

### 4. Функции базы данных

#### `update_pending_task_text()`
```python
def update_pending_task_text(item_id: int, new_task_text: str) -> None:
    """Update the task text for a pending prioritization item."""
    with db_cursor() as cur:
        cur.execute(
            "UPDATE pending_prioritization SET task_text = ? WHERE id = ?",
            (new_task_text, item_id),
        )
```

**Функциональность:**
- Обновляет текст задачи в таблице `pending_prioritization`
- Использует транзакционную безопасность через `db_cursor()`
- Логирует операцию обновления

## Поток работы

### Сценарий редактирования задачи

1. **Пользователь видит задачу** с кнопками выбора приоритета
2. **Нажимает "Редактировать"** → бот отправляет "Напишите правильную формулировку задачи"
3. **Пользователь пишет новый текст** → бот принимает его как описание задачи
4. **Бот обновляет задачу** в базе данных
5. **Отправляется новое сообщение** с обновленным текстом и кнопками выбора приоритета
6. **Исходное сообщение редактирования удаляется** из чата

### Пример взаимодействия

```
Бот: Новая задача:
     Выполнить хотфикс по деталям, указанным в чате аппхада.
     Выберите приоритет:
     [Critical] [Blocker] [High] [Medium] [Low]
     [Редактировать] [Удалить]

Пользователь: [Редактировать]

Бот: Напишите правильную формулировку задачи

Пользователь: Исправить критическую ошибку в системе авторизации

Бот: Новая задача:
     Исправить критическую ошибку в системе авторизации
     Выберите приоритет:
     [Critical] [Blocker] [High] [Medium] [Low]
     [Редактировать] [Удалить]
```

## Обработка ошибок

### Graceful Degradation
- При ошибке обновления базы данных контекст редактирования очищается
- Пользователь возвращается к обычному режиму работы
- Все ошибки логируются для диагностики

### Валидация данных
- Проверка существования задачи перед редактированием
- Проверка соответствия `chat_id` для безопасности
- Автоматическая очистка контекста при ошибках

## Безопасность

### Изоляция пользователей
- Каждый пользователь имеет свой контекст редактирования
- `chat_id` проверяется для предотвращения межчатового редактирования
- Контекст автоматически очищается после использования

### Логирование
- Все операции редактирования логируются
- Отслеживается `pending_id` и новый текст задачи
- Логируются ошибки и исключения

## Интеграция с существующей системой

### Совместимость
- Не влияет на существующую логику выбора приоритета
- Работает параллельно с системой лимитов срочных задач
- Сохраняет все существующие функции

### Обновление данных
- Изменения отражаются в Google Sheets при выборе приоритета
- Обновленный текст сохраняется в `processed_tasks`
- Исходные сообщения помечаются как обработанные после выбора приоритета

## Тестирование

### Сценарии тестирования
1. **Успешное редактирование** - изменение текста и выбор приоритета
2. **Обработка ошибок** - неверный `pending_id`, ошибки базы данных
3. **Безопасность** - попытки редактирования чужих задач
4. **Интеграция** - работа с системой лимитов и Google Sheets

### Проверка функциональности
- Кнопка "Редактировать" отображается корректно
- Режим редактирования активируется и деактивируется
- База данных обновляется правильно
- Новое сообщение с приоритетами отправляется
- Исходное сообщение редактирования удаляется

## Возможности расширения

### Дополнительные функции
- **История изменений** - отслеживание всех изменений задачи
- **Множественное редактирование** - возможность редактировать несколько полей
- **Шаблоны задач** - предустановленные формулировки для типовых задач
- **Уведомления** - оповещение других участников об изменении задачи

### Интеграции
- **Jira/Redmine** - синхронизация изменений с внешними системами
- **Slack/Teams** - уведомления в корпоративных чатах
- **Email** - рассылка обновлений по email
