# Changelog

## [Unreleased] - 2024-12-19

### Added
- **Новая функциональность проверки лимита срочных задач**
  - Добавлена проверка лимита в 5 срочных задач при выборе высокого приоритета
  - Новые функции в `utils/gsheets.py`:
    - `get_high_priority_tasks()` - получение списка срочных задач из двух листов
    - `format_tasks_message()` - форматирование сообщения о превышении лимита
    - `is_high_priority_limit_exceeded()` - проверка превышения лимита
  - Новые обработчики в `bot/handlers.py`:
    - `handle_downgrade_callback` - обработка понижения приоритета
    - `handle_edit_task_callback` - обработка редактирования задачи
    - `handle_keep_high_callback` - обработка сохранения высокого приоритета
  - Модификация `handle_priority_callback` для проверки лимита
  - Регистрация новых обработчиков в `main.py`
  - **Функциональность редактирования задач**
    - Кнопка "Редактировать" во всех местах выбора приоритета
    - Возможность изменить формулировку задачи перед выбором приоритета
    - Интерактивный процесс редактирования с автоматическим обновлением

### Changed
- **Модифицирован обработчик выбора приоритета**
  - Добавлена проверка лимита срочных задач перед добавлением в Google Sheets
  - При превышении лимита показываются альтернативные варианты действий
  - Новые inline-кнопки для выбора приоритета при превышении лимита
- **Исправлена критическая ошибка в логике обработки сообщений**
  - Сообщения теперь помечаются как обработанные только ПОСЛЕ выбора приоритета
  - Команда `/parse` игнорирует статус `is_processed` для повторной обработки
  - Задачи остаются в очереди приоритизации до выбора приоритета

### Technical Details
- **Константы**: Лимит 5 задач и username менеджера @pakhandrin захардкожены
- **Структура Google Sheets**: Поддержка двух листов с разной структурой столбцов
- **Обработка ошибок**: Graceful degradation при ошибках чтения Google Sheets
- **Логирование**: Подробное логирование всех операций с лимитом

### Files Modified
- `utils/gsheets.py` - добавлены новые функции для работы с лимитом
- `bot/handlers.py` - модифицирован обработчик приоритетов, добавлены новые обработчики
- `bot/scheduler.py` - исправлена логика обработки сообщений
- `database/operations.py` - добавлены функции для редактирования задач
- `main.py` - зарегистрированы новые обработчики callback'ов

### Files Added
- `docs/high-priority-limit-feature.md` - документация по новой функциональности
- `test_high_priority_limit.py` - тестовый скрипт для проверки функций

### Configuration
- Используются существующие переменные окружения для Google Sheets
- Структура столбцов захардкожена (C - статус, D - приоритет для основного листа)
- Активные статусы разработки захардкожены
- **Два уровня лимитов:**
  - Лимит срочных задач: 5 (Critical/Blocker/High) - для проверки перед добавлением
  - Лимит важных задач: 10 - для Google Sheets интеграции

### Testing
- Создан тестовый скрипт для проверки основных функций
- Тестирование требует настроенного Google Sheets API
- Проверка работы с ошибками и graceful degradation
