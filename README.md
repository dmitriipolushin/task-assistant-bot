## Telegram TaskTracker Bot

Бот для сбора клиентских задач в групповых чатах, пакетной обработки раз в час через GPT-5 и ежедневных отчетов.

### Требования
- Python 3.11+

### Установка
1. Создай и активируй виртуальное окружение
   - macOS/Linux: `python3 -m venv .venv && source .venv/bin/activate`
   - Windows: `py -3 -m venv .venv && .venv\\Scripts\\activate`
2. Установка зависимостей
   - `pip install -r requirements.txt`
3. Создай `.env` по примеру `.env.example`

### Запуск
```
python main.py
```

### Переменные окружения
- `BOT_TOKEN` — токен Telegram бота
- `OPENAI_API_KEY` — ключ OpenAI
- `GPT_MODEL` — модель OpenAI, настройте доступную для вашего проекта
- `TIMEZONE` — временная зона (по умолчанию Europe/Moscow)
- `DAILY_REPORT_TIME` — время ежедневного отчета, формат HH:MM (по умолчанию 09:00)
- `DATABASE_PATH` — путь к SQLite базе (по умолчанию ./data/bot.db)
— Интеграция с Google Sheets:
- `GSHEET_SPREADSHEET_ID` — ID таблицы (из URL между /d/ и /edit)
- `GSHEET_WORKSHEET_NAME` — имя основного листа (по умолчанию `Main`)
- `GSHEET_TASKS_WORKSHEET_NAME` — имя листа для задач (по умолчанию `Tasks`)
- `GOOGLE_SERVICE_ACCOUNT_JSON_PATH` — абсолютный путь к JSON‑ключу сервис‑аккаунта ИЛИ сам JSON одной строкой
  

### Docker
Запуск локально:
```
docker compose up --build
```

### Докплой (Dokploy)
- Создай приложение (Dockerfile или Compose)
- Добавь переменные окружения
- Подключи volume для `/app/data`

### Команды бота
- `/tasks [page]` — список задач с пагинацией (20 на страницу)
- `/process_now` — форсировать обработку часа (только сотрудники)
- `/parse <days>` — обработать все необработанные сообщения за последние N дней (только сотрудники)
- `/prioritize` — прислать клавиатуры для выбора приоритета по всем задачам, ожидающим приоритизации

### Функциональность
- **Сбор сообщений**: текст из групповых чатов сохраняется в `raw_messages`; сообщения сотрудников из `config/staff_list.py` игнорируются.
- **Пакетная обработка (GPT)**: раз в час берутся сообщения за последний час, объединяются в контекст, отправляются в GPT; извлеченные задачи сохраняются в `processed_tasks`, исходные сообщения помечаются обработанными. Каждая новая задача ставится в очередь `pending_prioritization` и в чат отправляется инлайн‑клавиатура выбора приоритета.
- **Приоритизация**: нажимать инлайн‑кнопки могут все участники чата. После выбора приоритета задача добавляется в Google Sheets (см. ниже), запись в `pending_prioritization` удаляется. Команда `/prioritize` повторно присылает клавиатуры для всех задач, которые ещё ждут выбора приоритета. В клавиатуре есть кнопка «Удалить» — удаляет задачу только из БД (из Google Sheets ничего не удаляется).
- **Лимит важных задач**: если суммарно задач с приоритетами `Critical|Blocker|High` становится > 10, автоматически понижается приоритет у последней (LIFO) до `Medium` в Google Sheets.
- **Ежедневные отчеты**: в `DAILY_REPORT_TIME` по `TIMEZONE` бот отправляет сводку задач за предыдущий день в каждый активный чат.
- **Ограничения Telegram**: длинные ответы автоматически бьются на сообщения по 4096 символов.

### Архитектура
- `main.py` — точка входа, регистрация хендлеров, запуск планировщика, graceful shutdown.
- `bot/handlers.py` — обработка текстов, `/tasks`, `/process_now`, `/parse`, `/prioritize`, коллбэки приоритета/удаления.
- `bot/scheduler.py` — ежечасная обработка и ежедневные отчеты; показ клавиатуры выбора приоритета при появлении новых задач.
- `bot/gpt_processor.py` — форматирование контекста и вызов OpenAI с retry (exponential backoff).
- `database/models.py` — инициализация SQLite, индексы.
- `database/operations.py` — CRUD и выборки; очереди `pending_prioritization` и задачи `processed_tasks`.
- `utils/formatters.py` — форматирование списков задач и отчетов.
- `utils/gsheets.py` — интеграция с Google Sheets: добавление строк, поиск/понижение приоритетов, лимит 10 важных.

### Google Sheets
- **Авторизация**: используйте сервис‑аккаунт Google. В `.env` задайте `GOOGLE_SERVICE_ACCOUNT_JSON_PATH` как путь к JSON‑файлу ключа или сам JSON одной строкой. Дайте доступ к таблице (Editor) на e‑mail сервис‑аккаунта.
- **Таблица**: задачи записываются в отдельный лист `Tasks` (настраивается через `GSHEET_TASKS_WORKSHEET_NAME`). Если листа нет — создается со схемой колонок: `Проект | Описание | Приоритет`. Все задачи автоматически получают проект "Calzen".
- **Запись**: добавление строки происходит при выборе приоритета в инлайн‑кнопках. Формат записи: Проект (Calzen), Описание задачи, Приоритет.
- **Лимит 10**: при превышении лимита «важных» (`Critical|Blocker|High`) бот автоматически понижает приоритет у последней задачи до `Medium`.

### База данных (SQLite)
- `raw_messages(id, chat_id, message_id, client_username, client_first_name, message_text, timestamp, is_processed)`
- `processed_tasks(id, chat_id, task_text, source_messages(JSON), processing_timestamp, created_date)`
- `staff_members(id, username UNIQUE, user_id UNIQUE)`
- Индексы: по `chat_id`, `timestamp`, `is_processed`, `created_date`.

### Планировщик
- Ежечасная задача: обрабатывает накопившиеся сообщения за последний час для каждого чата.
- Ежедневный отчет: отправляет отчет за предыдущий день по чату.
- `/process_now`: немедленная обработка последнего часа.
- `/parse <days>`: обработка за диапазон `[now - days, now]`.

### Логирование и запуск в контейнере
- Логи — в stdout c уровнями; Dockerfile содержит healthcheck для SQLite.
- Персистентность БД — volume на `/app/data`.

### Примеры
```
/tasks
/tasks 2
/process_now
/parse 3
```


